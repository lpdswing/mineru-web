import{Z as ce,p as ue,r as x,j as pe,a as me,S as _e,_ as fe,w as T,y as V,z as g,G as S,B as l,C as n,E as r,V as d,u as _,P as ge,F as I,A as M,U as h,L as ve,W as he,Y as z,$ as W,H as b}from"./element-plus-4BRiPEl_.js";import{u as be,_ as ye}from"./index-BdVRlj0D.js";import{r as we}from"./office-CR6qq4tO.js";import{a as ke}from"./utils-TXqgcX9H.js";import{b as w,c as Ce,d as xe,f as ze,e as N,h as Fe,i as Se}from"./status-DoXMCZ5b.js";import"./index-DLFCGwAH.js";import"./user-DdPDo_0j.js";var Ue=we();const Ee=ce(Ue),G={MARKDOWN:"markdown",MARKDOWN_PAGE:"markdown_page"},$={[G.MARKDOWN]:"Markdown",[G.MARKDOWN_PAGE]:"Markdown带页码"},Re={class:"files-root"},Le={class:"files-card"},Be={class:"files-header"},$e={class:"files-header-actions"},Pe={class:"files-toolbar"},Te={style:{display:"flex","align-items":"center",gap:"8px"}},Ve={class:"pagination-container"},Ne=3e3,Oe=ue({__name:"Files",setup(Ae){const c=x([]),U=x(0),E=x(!1),R=x(null),o=pe({page:1,pageSize:10,search:"",status:""}),L=x(""),k=x(!1),f=x([]),K=be(),J=me(()=>c.value.some(t=>t.status==="parsing")),Z=t=>{K.push({name:"FilePreview",params:{id:t.id}})},q=async(t,e)=>{if(!(!t||L.value===t.id)){L.value=t.id;try{const s=await w.exportFile(t.id,e);if(s.status==="success"){const u=await(await fetch(s.download_url)).blob(),p=window.URL.createObjectURL(u),m=document.createElement("a");m.href=p,m.download=s.filename,document.body.appendChild(m),m.click(),window.URL.revokeObjectURL(p),document.body.removeChild(m),z.success(`导出${$[e]}成功`)}}catch{}finally{L.value=""}}},P=()=>{R.value&&(clearInterval(R.value),R.value=null)},H=t=>{if(c.value.length!==t.length){c.value=t;return}t.forEach((e,s)=>{const i=c.value[s];i.id===e.id&&i.status!==e.status&&(c.value[s]=e)})},O=()=>{P(),R.value=window.setInterval(async()=>{await Y()},Ne)},Y=async()=>{try{const t=await w.getFiles({page:o.page,page_size:o.pageSize,search:o.search,status:o.status});H(t.files),U.value=t.total}catch{}},F=async()=>{E.value=!0;try{const t=await w.getFiles({page:o.page,page_size:o.pageSize,search:o.search,status:o.status});c.value=t.files,U.value=t.total}catch{c.value=[],U.value=0}finally{E.value=!1}},Q=t=>{W.confirm("确定要删除该文件吗？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await w.deleteFile(t.id),z.success("删除成功"),F()}catch{}}).catch(()=>{})},X=async t=>{try{const e=await w.getDownloadUrl(t.id),s=await ke.get(e.url,{responseType:"blob"}),i=new Blob([s.data]),u=window.URL.createObjectURL(i),p=document.createElement("a");p.href=u,p.download=t.filename,document.body.appendChild(p),p.click(),window.URL.revokeObjectURL(u),document.body.removeChild(p)}catch{}},ee=async()=>{!f.value.length||k.value||W.confirm(`确定要删除选中的 ${f.value.length} 个文件吗？`,"批量删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{k.value=!0;const t=[];try{const e=f.value.map(async s=>{try{await w.deleteFile(s.id)}catch{t.push(s.filename)}});await Promise.all(e),t.length===0?z.success(`成功删除 ${f.value.length} 个文件`):t.length<f.value.length?z.warning(`成功删除 ${f.value.length-t.length} 个文件，${t.length} 个文件删除失败`):z.error("所有文件删除失败"),F()}catch{}finally{k.value=!1}}).catch(()=>{})},te=async t=>{if(!(!f.value.length||k.value)){k.value=!0;try{const e=new Ee;for(const p of f.value)try{const m=await w.exportFile(p.id,t);if(m.status==="success"){const C=await(await fetch(m.download_url)).blob();e.file(m.filename,C)}}catch{}const s=await e.generateAsync({type:"blob"}),i=window.URL.createObjectURL(s),u=document.createElement("a");u.href=i,u.download=`batch_export_${new Date().getTime()}.zip`,document.body.appendChild(u),u.click(),window.URL.revokeObjectURL(i),document.body.removeChild(u),z.success(`批量导出${$[t]}完成`)}catch{}finally{k.value=!1}}},ae=t=>{f.value=t},le=async t=>{try{await w.parseFile(t.id),z.success("解析任务已提交");const e=c.value.findIndex(s=>s.id===t.id);e!==-1&&(c.value[e]={...c.value[e],status:"parsing"})}catch{}},B=()=>{F()},ne=()=>{o.page=1,F()};return _e(()=>{F().then(()=>{O()})}),fe(()=>{P()}),T([()=>o.search,()=>o.status],()=>{ne()}),T([()=>o.page,()=>o.pageSize],()=>{F()}),T(J,t=>{t?O():P()}),(t,e)=>{const s=r("el-icon"),i=r("el-button"),u=r("el-dropdown-item"),p=r("el-dropdown-menu"),m=r("el-dropdown"),A=r("el-input"),C=r("el-option"),se=r("el-select"),y=r("el-table-column"),D=r("el-tag"),oe=r("el-table"),ie=r("el-empty"),de=r("el-skeleton"),re=r("el-pagination");return b(),V("div",Re,[g("div",Le,[g("div",Be,[e[10]||(e[10]=g("span",{class:"files-title"},"文件列表",-1)),g("div",$e,[l(i,{type:"danger",size:"large",class:"batch-delete-btn",onClick:ee,disabled:!f.value.length,plain:""},{default:n(()=>[l(s,null,{default:n(()=>[l(_(ge))]),_:1}),e[5]||(e[5]=d(" 批量删除 "))]),_:1,__:[5]},8,["disabled"]),l(m,{onCommand:te,disabled:!f.value.length},{dropdown:n(()=>[l(p,null,{default:n(()=>[(b(!0),V(I,null,M(_($),(a,v)=>(b(),S(u,{key:v,command:v},{default:n(()=>[d(h(a),1)]),_:2},1032,["command"]))),128))]),_:1})]),default:n(()=>[l(i,{type:"info",size:"large",class:"batch-export-btn",loading:k.value,plain:""},{default:n(()=>[l(s,null,{default:n(()=>e[6]||(e[6]=[g("i",{class:"el-icon-download"},null,-1)])),_:1,__:[6]}),e[8]||(e[8]=d(" 批量导出 ")),l(s,null,{default:n(()=>e[7]||(e[7]=[g("i",{class:"el-icon-arrow-down"},null,-1)])),_:1,__:[7]})]),_:1,__:[8]},8,["loading"])]),_:1},8,["disabled"]),l(i,{type:"primary",size:"large",class:"upload-btn",onClick:e[0]||(e[0]=a=>t.$router.push("/upload"))},{default:n(()=>[l(s,null,{default:n(()=>[l(_(ve))]),_:1}),e[9]||(e[9]=d(" 上传文件 "))]),_:1,__:[9]})])]),g("div",Pe,[l(A,{modelValue:o.search,"onUpdate:modelValue":e[1]||(e[1]=a=>o.search=a),placeholder:"请输入文件名称",class:"search-input",clearable:"","prefix-icon":"Search",onInput:B},null,8,["modelValue"]),l(se,{modelValue:o.status,"onUpdate:modelValue":e[2]||(e[2]=a=>o.status=a),placeholder:"筛选状态",class:"status-select",clearable:"",onChange:B},{default:n(()=>[l(C,{label:"全部",value:""}),l(C,{label:"等待解析",value:"pending"}),l(C,{label:"解析中",value:"parsing"}),l(C,{label:"已完成",value:"parsed"}),l(C,{label:"解析失败",value:"parse_failed"})]),_:1},8,["modelValue"])]),c.value&&c.value.length>0&&!E.value?(b(),S(oe,{key:0,data:c.value,border:"",stripe:"",onSelectionChange:ae},{default:n(()=>[l(y,{type:"selection",width:"48"}),l(y,{prop:"filename",label:"文件名称"},{default:n(({row:a})=>[g("div",Te,[a.backend?(b(),S(D,{key:0,size:"small",color:_(Ce)(a.backend),style:{color:"white",border:"none",padding:"0 6px",height:"20px","line-height":"20px"}},{default:n(()=>[d(h(_(xe)(a.backend)),1)]),_:2},1032,["color"])):he("",!0),g("span",null,h(a.filename),1)])]),_:1}),l(y,{prop:"size",label:"大小",width:"120"},{default:n(({row:a})=>[d(h(_(ze)(a.size)),1)]),_:1}),l(y,{prop:"uploadTime",label:"创建时间",width:"180"},{default:n(({row:a})=>[d(h(_(N)(a.upload_time)),1)]),_:1}),l(y,{prop:"start_at",label:"开始时间",width:"180"},{default:n(({row:a})=>[d(h(_(N)(a.start_at)),1)]),_:1}),l(y,{prop:"finish_at",label:"结束时间",width:"180"},{default:n(({row:a})=>[d(h(_(N)(a.finish_at)),1)]),_:1}),l(y,{prop:"status",label:"状态",width:"120"},{default:n(({row:a})=>[l(D,{type:_(Fe)(a.status)},{default:n(()=>[d(h(_(Se)(a.status)),1)]),_:2},1032,["type"])]),_:1}),l(y,{label:"操作",width:"260"},{default:n(({row:a})=>[l(i,{type:"primary",link:"",onClick:v=>Z(a)},{default:n(()=>e[11]||(e[11]=[d("查看")])),_:2,__:[11]},1032,["onClick"]),l(i,{type:"success",link:"",onClick:v=>X(a)},{default:n(()=>e[12]||(e[12]=[d("下载")])),_:2,__:[12]},1032,["onClick"]),l(i,{type:"danger",link:"",onClick:v=>Q(a)},{default:n(()=>e[13]||(e[13]=[d("删除")])),_:2,__:[13]},1032,["onClick"]),l(i,{type:"warning",link:"",onClick:v=>le(a),disabled:a.status==="parsed"||a.status==="parsing",title:a.status==="parsed"?"文件已解析完成":a.status==="parsing"?"文件正在解析中":"开始解析"},{default:n(()=>e[14]||(e[14]=[d("解析")])),_:2,__:[14]},1032,["onClick","disabled","title"]),l(m,{onCommand:v=>q(a,v)},{dropdown:n(()=>[l(p,null,{default:n(()=>[(b(!0),V(I,null,M(_($),(v,j)=>(b(),S(u,{key:j,command:j},{default:n(()=>[d(h(v),1)]),_:2},1032,["command"]))),128))]),_:1})]),default:n(()=>[l(i,{type:"info",link:"",loading:L.value===a.id},{default:n(()=>[e[16]||(e[16]=d(" 导出 ")),l(s,null,{default:n(()=>e[15]||(e[15]=[g("i",{class:"el-icon-arrow-down"},null,-1)])),_:1,__:[15]})]),_:2,__:[16]},1032,["loading"])]),_:2},1032,["onCommand"])]),_:1})]),_:1},8,["data"])):E.value?(b(),S(de,{key:2,rows:6,animated:"",style:{margin:"32px 0"}})):(b(),S(ie,{key:1,description:"暂无数据","image-size":80,class:"files-empty"})),g("div",Ve,[l(re,{"current-page":o.page,"onUpdate:currentPage":e[3]||(e[3]=a=>o.page=a),"page-size":o.pageSize,"onUpdate:pageSize":e[4]||(e[4]=a=>o.pageSize=a),total:U.value,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next",onSizeChange:B,onCurrentChange:B},null,8,["current-page","page-size","total"])])])])}}}),Je=ye(Oe,[["__scopeId","data-v-48f0cbcc"]]);export{Je as default};
