import{p as ge,a as fe,j as z,q as _e,o as he,v as ve,x as M,c as T,b as _,k as B,f as a,w as l,r as p,E as r,e as d,u as N,y as ye,F as j,z as X,t as v,g as be,m as we,A as ke,B as K,i as U,_ as Ce}from"./index-C3u7JP-Y.js";import{a as y,g as w}from"./user-COjPqb4h.js";import{r as xe}from"./jszip.min-DOB73FcA.js";import{f as ze}from"./format-B3wa2IJS.js";var Ue=xe();const $e=ge(Ue),Ee={class:"files-root"},Ie={class:"files-card"},Le={class:"files-header"},Re={class:"files-header-actions"},Se={class:"files-toolbar"},Be={style:{display:"flex","align-items":"center",gap:"8px"}},Fe={class:"pagination-container"},Te=3e3,Ne=fe({__name:"Files",setup(Pe){const g=z([]),E=z(0),I=z(!1),L=z(null),o=_e({page:1,pageSize:10,search:"",status:""}),R=z(""),k=z(!1),f=z([]),W=ke(),P={MARKDOWN:"markdown",MARKDOWN_PAGE:"markdown_page"},C={[P.MARKDOWN]:"Markdown",[P.MARKDOWN_PAGE]:"Markdown带页码"},F=t=>t?new Date(t).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}):"",G=t=>({pending:"info",parsing:"warning",parsed:"success",parse_failed:"danger"})[t]||"info",q=t=>({pending:"等待解析",parsing:"解析中",parsed:"已完成",parse_failed:"解析失败"})[t]||"未知状态",J=t=>{switch(t){case"pipeline":return"Pipeline";case"vlm":return"VLM";default:return""}},Z=t=>{switch(t){case"pipeline":return"#409EFF";case"vlm":return"#67C23A";default:return"#909399"}},H=t=>{W.push({name:"FilePreview",params:{id:t.id}})},Q=async(t,e)=>{if(!(!t||R.value===t.id)){R.value=t.id;try{const s=await y.get(`/api/files/${t.id}/export`,{params:{format:e},headers:{"X-User-Id":w()}});if(s.data.status==="success"){const m=await(await fetch(s.data.download_url)).blob(),c=window.URL.createObjectURL(m),u=document.createElement("a");u.href=c,u.download=s.data.filename,document.body.appendChild(u),u.click(),window.URL.revokeObjectURL(c),document.body.removeChild(u),r.success(`导出${C[e]}成功`)}else r.error(`导出${C[e]}失败`)}catch(s){console.error("导出失败:",s),r.error(`导出${C[e]}失败`)}finally{R.value=""}}},V=()=>{L.value&&(clearInterval(L.value),L.value=null)},Y=t=>{if(g.value.length!==t.length){g.value=t;return}t.forEach((e,s)=>{const i=g.value[s];i.id===e.id&&i.status!==e.status&&(g.value[s]=e)})},ee=()=>{console.log("开始轮询..."),V(),L.value=window.setInterval(async()=>{await te()},Te)},te=async()=>{try{const t=await y.get("/api/files",{params:{page:o.page,page_size:o.pageSize,search:o.search,status:o.status},headers:{"X-User-Id":w()}});Y(t.data.files),E.value=t.data.total}catch(t){console.error("轮询获取文件列表失败:",t)}},$=async()=>{I.value=!0;try{const t=await y.get("/api/files",{params:{page:o.page,page_size:o.pageSize,search:o.search,status:o.status},headers:{"X-User-Id":w()}});g.value=t.data.files,E.value=t.data.total}catch{r.error("获取文件列表失败"),g.value=[],E.value=0}finally{I.value=!1}},ae=t=>{K.confirm("确定要删除该文件吗？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await y.delete(`/api/files/${t.id}`,{headers:{"X-User-Id":w()}}),r.success("删除成功"),$()}catch{r.error("删除失败")}}).catch(()=>{})},ne=async t=>{try{const e=await y.get(`/api/files/${t.id}/download_url`,{headers:{"X-User-Id":w()}}),s=await y.get(e.data.url,{responseType:"blob"}),i=new Blob([s.data]),m=window.URL.createObjectURL(i),c=document.createElement("a");c.href=m,c.download=t.filename,document.body.appendChild(c),c.click(),window.URL.revokeObjectURL(m),document.body.removeChild(c)}catch{r.error("下载失败")}},le=async()=>{!f.value.length||k.value||K.confirm(`确定要删除选中的 ${f.value.length} 个文件吗？`,"批量删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{k.value=!0;const t=[];try{const e=f.value.map(async s=>{try{await y.delete(`/api/files/${s.id}`,{headers:{"X-User-Id":w()}})}catch(i){t.push(s.filename),console.error(`删除文件 ${s.filename} 失败:`,i)}});await Promise.all(e),t.length===0?r.success(`成功删除 ${f.value.length} 个文件`):t.length<f.value.length?r.warning(`成功删除 ${f.value.length-t.length} 个文件，${t.length} 个文件删除失败`):r.error("所有文件删除失败"),$()}catch(e){console.error("批量删除失败:",e),r.error("批量删除操作失败")}finally{k.value=!1}}).catch(()=>{})},se=async t=>{if(!(!f.value.length||k.value)){k.value=!0;try{const e=new $e;for(const c of f.value)try{const u=await y.get(`/api/files/${c.id}/export`,{params:{format:t},headers:{"X-User-Id":w()}});if(u.data.status==="success"){const x=await(await fetch(u.data.download_url)).blob();e.file(u.data.filename,x)}}catch(u){console.error(`导出文件 ${c.filename} 失败:`,u),r.error(`导出文件 ${c.filename} 失败`)}const s=await e.generateAsync({type:"blob"}),i=window.URL.createObjectURL(s),m=document.createElement("a");m.href=i,m.download=`batch_export_${new Date().getTime()}.zip`,document.body.appendChild(m),m.click(),window.URL.revokeObjectURL(i),document.body.removeChild(m),r.success(`批量导出${C[t]}完成`)}catch(e){console.error("批量导出失败:",e),r.error(`批量导出${C[t]}失败`)}finally{k.value=!1}}},oe=t=>{f.value=t},ie=async t=>{try{await y.post(`/api/files/${t.id}/parse`,{},{headers:{"X-User-Id":w()}}),r.success("解析任务已提交");const e=g.value.findIndex(s=>s.id===t.id);e!==-1&&(g.value[e]={...g.value[e],status:"parsing"})}catch{r.error("解析任务提交失败")}},S=()=>{$()},re=()=>{o.page=1,$()};return he(()=>{$().then(()=>{ee()})}),ve(()=>{V()}),M([()=>o.search,()=>o.status],()=>{re()}),M([()=>o.page,()=>o.pageSize],()=>{$()}),(t,e)=>{const s=p("el-icon"),i=p("el-button"),m=p("el-dropdown-item"),c=p("el-dropdown-menu"),u=p("el-dropdown"),O=p("el-input"),x=p("el-option"),de=p("el-select"),b=p("el-table-column"),A=p("el-tag"),ce=p("el-table"),ue=p("el-empty"),pe=p("el-skeleton"),me=p("el-pagination");return U(),T("div",Ee,[_("div",Ie,[_("div",Le,[e[10]||(e[10]=_("span",{class:"files-title"},"文件列表",-1)),_("div",Re,[a(i,{type:"danger",size:"large",class:"batch-delete-btn",onClick:le,disabled:!f.value.length,plain:""},{default:l(()=>[a(s,null,{default:l(()=>[a(N(ye))]),_:1}),e[5]||(e[5]=d(" 批量删除 "))]),_:1,__:[5]},8,["disabled"]),a(u,{onCommand:se,disabled:!f.value.length},{dropdown:l(()=>[a(c,null,{default:l(()=>[(U(),T(j,null,X(C,(n,h)=>a(m,{key:h,command:h},{default:l(()=>[d(v(n),1)]),_:2},1032,["command"])),64))]),_:1})]),default:l(()=>[a(i,{type:"info",size:"large",class:"batch-export-btn",loading:k.value,plain:""},{default:l(()=>[a(s,null,{default:l(()=>e[6]||(e[6]=[_("i",{class:"el-icon-download"},null,-1)])),_:1,__:[6]}),e[8]||(e[8]=d(" 批量导出 ")),a(s,null,{default:l(()=>e[7]||(e[7]=[_("i",{class:"el-icon-arrow-down"},null,-1)])),_:1,__:[7]})]),_:1,__:[8]},8,["loading"])]),_:1},8,["disabled"]),a(i,{type:"primary",size:"large",class:"upload-btn",onClick:e[0]||(e[0]=n=>t.$router.push("/upload"))},{default:l(()=>[a(s,null,{default:l(()=>[a(N(be))]),_:1}),e[9]||(e[9]=d(" 上传文件 "))]),_:1,__:[9]})])]),_("div",Se,[a(O,{modelValue:o.search,"onUpdate:modelValue":e[1]||(e[1]=n=>o.search=n),placeholder:"请输入文件名称",class:"search-input",clearable:"","prefix-icon":"Search",onInput:S},null,8,["modelValue"]),a(de,{modelValue:o.status,"onUpdate:modelValue":e[2]||(e[2]=n=>o.status=n),placeholder:"筛选状态",class:"status-select",clearable:"",onChange:S},{default:l(()=>[a(x,{label:"全部",value:""}),a(x,{label:"等待解析",value:"pending"}),a(x,{label:"解析中",value:"parsing"}),a(x,{label:"已完成",value:"parsed"}),a(x,{label:"解析失败",value:"parse_failed"})]),_:1},8,["modelValue"])]),g.value&&g.value.length>0&&!I.value?(U(),B(ce,{key:0,data:g.value,border:"",stripe:"",onSelectionChange:oe},{default:l(()=>[a(b,{type:"selection",width:"48"}),a(b,{prop:"filename",label:"文件名称"},{default:l(({row:n})=>[_("div",Be,[n.backend?(U(),B(A,{key:0,size:"small",color:Z(n.backend),style:{color:"white",border:"none",padding:"0 6px",height:"20px","line-height":"20px"}},{default:l(()=>[d(v(J(n.backend)),1)]),_:2},1032,["color"])):we("",!0),_("span",null,v(n.filename),1)])]),_:1}),a(b,{prop:"size",label:"大小",width:"120"},{default:l(({row:n})=>[d(v(N(ze)(n.size)),1)]),_:1}),a(b,{prop:"uploadTime",label:"创建时间",width:"180"},{default:l(({row:n})=>[d(v(F(n.upload_time)),1)]),_:1}),a(b,{prop:"start_at",label:"开始时间",width:"180"},{default:l(({row:n})=>[d(v(F(n.start_at)),1)]),_:1}),a(b,{prop:"finish_at",label:"结束时间",width:"180"},{default:l(({row:n})=>[d(v(F(n.finish_at)),1)]),_:1}),a(b,{prop:"status",label:"状态",width:"120"},{default:l(({row:n})=>[a(A,{type:G(n.status)},{default:l(()=>[d(v(q(n.status)),1)]),_:2},1032,["type"])]),_:1}),a(b,{label:"操作",width:"260"},{default:l(({row:n})=>[a(i,{type:"primary",link:"",onClick:h=>H(n)},{default:l(()=>e[11]||(e[11]=[d("查看")])),_:2,__:[11]},1032,["onClick"]),a(i,{type:"success",link:"",onClick:h=>ne(n)},{default:l(()=>e[12]||(e[12]=[d("下载")])),_:2,__:[12]},1032,["onClick"]),a(i,{type:"danger",link:"",onClick:h=>ae(n)},{default:l(()=>e[13]||(e[13]=[d("删除")])),_:2,__:[13]},1032,["onClick"]),a(i,{type:"warning",link:"",onClick:h=>ie(n),disabled:n.status==="parsed"||n.status==="parsing",title:n.status==="parsed"?"文件已解析完成":n.status==="parsing"?"文件正在解析中":"开始解析"},{default:l(()=>e[14]||(e[14]=[d("解析")])),_:2,__:[14]},1032,["onClick","disabled","title"]),a(u,{onCommand:h=>Q(n,h)},{dropdown:l(()=>[a(c,null,{default:l(()=>[(U(),T(j,null,X(C,(h,D)=>a(m,{key:D,command:D},{default:l(()=>[d(v(h),1)]),_:2},1032,["command"])),64))]),_:1})]),default:l(()=>[a(i,{type:"info",link:"",loading:R.value===n.id},{default:l(()=>[e[16]||(e[16]=d(" 导出 ")),a(s,null,{default:l(()=>e[15]||(e[15]=[_("i",{class:"el-icon-arrow-down"},null,-1)])),_:1,__:[15]})]),_:2,__:[16]},1032,["loading"])]),_:2},1032,["onCommand"])]),_:1})]),_:1},8,["data"])):I.value?(U(),B(pe,{key:2,rows:6,animated:"",style:{margin:"32px 0"}})):(U(),B(ue,{key:1,description:"暂无数据","image-size":80,class:"files-empty"})),_("div",Fe,[a(me,{"current-page":o.page,"onUpdate:currentPage":e[3]||(e[3]=n=>o.page=n),"page-size":o.pageSize,"onUpdate:pageSize":e[4]||(e[4]=n=>o.pageSize=n),total:E.value,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next",onSizeChange:S,onCurrentChange:S},null,8,["current-page","page-size","total"])])])])}}}),Me=Ce(Ne,[["__scopeId","data-v-5bd18257"]]);export{Me as default};
