import{Z as ee,p as be,r as s,w as V,S as xe,a as J,y as d,a0 as Ce,z as l,a1 as Me,B as o,V as M,C as i,E as _,U as I,W as $,D as W,F as S,G as H,Y as g,u as O,a2 as $e,A as Q,I as Ue,a3 as ze,a4 as Pe,a5 as Ee,H as n}from"./element-plus-4BRiPEl_.js";import{a as k}from"./utils-TXqgcX9H.js";import{r as Fe,M as Le}from"./markdown-lgXXREof.js";import{a as Ie,b as Se,u as Oe}from"./office-CR6qq4tO.js";import{g as U}from"./user-DdPDo_0j.js";import{_ as Be}from"./index-BdVRlj0D.js";var Ne=Fe();const Te=ee(Ne);var De=Ie();const Ve=ee(De),We={class:"preview-wrapper"},He={class:"preview-sidebar"},Re={class:"sidebar-title"},Ae=["onClick"],Ke={class:"sidebar-file-name"},je={class:"sidebar-pagination-container"},Xe={class:"preview-main-area"},Ge={class:"preview-header"},qe={class:"file-title"},Ye={class:"view-toggle-group"},Ze={class:"preview-content"},Je={class:"left-content"},Qe={key:0,style:{"text-align":"center"}},ea=["src"],aa={key:0,class:"loading-office"},ta=["innerHTML"],sa=["src"],la={class:"right-content"},oa={class:"parsed-content-wrapper"},na=["innerHTML"],ra={key:0,class:"loading-more"},ia=be({__name:"FilePreview",setup(da){const ae=Le({html:!0,linkify:!0,typographer:!0}).use(Te),b=s(!1),w=s([]),z=s(1),P=s(10),B=s(0),E=s(""),R=async()=>{try{const e=await k.get("/api/files",{params:{page:z.value,page_size:P.value,search:E.value},headers:{"X-User-Id":U()}});w.value=e.data.files,B.value=e.data.total,w.value.length>0&&(!t.value||!w.value.find(a=>a.id===t.value.id))&&A(w.value[0])}catch{g.error("获取文件列表失败"),w.value=[],B.value=0}};V([z,P,E],R),xe(()=>{R()});const te=J(()=>w.value),t=s(w.value[0]),A=e=>{t.value=e,re.value=1,v.value!=="origin"&&X()},se=s(!0),le=e=>e?/\.(png|jpe?g|gif|bmp|webp)$/i.test(e):!1,K=e=>e?/\.(txt|md|json|log)$/i.test(e):!1,oe=e=>e?/\.(doc|docx)$/i.test(e):!1,ne=e=>e?/\.(xls|xlsx)$/i.test(e):!1,j=e=>e?/\.(doc|docx|xls|xlsx)$/i.test(e):!1,re=s(1),F=s(""),y=s(!1),ie=s(!0),X=async()=>{if(t.value){y.value=!0;try{const e=await k.get(`/api/files/${t.value.id}/parsed_content`,{headers:{"X-User-Id":U()}});F.value=e.data||""}catch{g.error("获取解析内容失败"),F.value=""}finally{y.value=!1}}},v=s("both"),G=e=>{v.value===e?v.value="both":v.value=e};V(v,e=>{e!=="origin"&&X()});const q={MARKDOWN:"markdown",MARKDOWN_PAGE:"markdown_page"},L={[q.MARKDOWN]:"Markdown",[q.MARKDOWN_PAGE]:"Markdown带页码"},de=async e=>{if(t.value)try{const a=await k.get(`/api/files/${t.value.id}/export`,{params:{format:e},headers:{"X-User-Id":U()}});if(a.data.status==="success"){const f=await(await fetch(a.data.download_url)).blob(),m=window.URL.createObjectURL(f),c=document.createElement("a");c.href=m,c.download=a.data.filename,document.body.appendChild(c),c.click(),window.URL.revokeObjectURL(m),document.body.removeChild(c),g.success(`导出${L[e]}成功`)}else g.error(`导出${L[e]}失败`)}catch{g.error(`导出${L[e]}失败`)}},p=s(""),x=s(""),h=s(""),N=s(!1),ue=async()=>{if(t.value)try{const e=await k.get(`/api/files/${t.value.id}/download_url`,{headers:{"X-User-Id":U()}});p.value=e.data.url}catch{p.value="",x.value="",h.value=""}},ce=async()=>{if(!(!t.value||!p.value)){N.value=!0;try{const a=await(await fetch(p.value)).blob();if(oe(t.value.filename)){const u=await a.arrayBuffer(),f=await Ve.convertToHtml({arrayBuffer:u});h.value=f.value}else if(ne(t.value.filename)){const u=await a.arrayBuffer(),f=Se(u,{type:"array"}),m=f.Sheets[f.SheetNames[0]],c=Oe.sheet_to_html(m);h.value=c}}catch{g.error("预览 Office 文件失败"),h.value=""}finally{N.value=!1}}},ve=async()=>{if(p.value)try{const e=await k.get(p.value);x.value=e.data}catch{x.value=""}};V(t,async e=>{e&&(p.value="",x.value="",h.value="",await ue(),K(e.filename)?await ve():j(e.filename)&&await ce())});const fe=e=>e?/\.pdf$/i.test(e):!1,C=s(null),Y=s(1),pe=()=>{var e;C.value&&((e=C.value.contentWindow)==null||e.addEventListener("scroll",me))},me=async()=>{var m,c;if(!C.value)return;const e=C.value,a=((m=e.contentWindow)==null?void 0:m.scrollY)||0,u=((c=e.contentWindow)==null?void 0:c.innerHeight)||0,f=Math.floor(a/u)+1;f!==Y.value&&(Y.value=f,await _e())},_e=async()=>{if(!(!t.value||y.value)){y.value=!0;try{const e=await k.get(`/api/files/${t.value.id}/parsed_content`,{headers:{"X-User-Id":U()}});F.value=e.data||"",ie.value=!1}catch{g.error("加载内容失败")}finally{y.value=!1}}},we=J(()=>ae.render(F.value||""));return(e,a)=>{var Z;const u=_("el-icon"),f=_("el-input"),m=_("el-scrollbar"),c=_("el-pagination"),T=_("el-button"),ge=_("el-dropdown-item"),ye=_("el-dropdown-menu"),he=_("el-dropdown"),ke=_("el-empty");return n(),d("div",We,[Ce(l("div",He,[l("div",Re,[o(u,{style:{"margin-right":"6px"}},{default:i(()=>[o(O($e))]),_:1}),a[6]||(a[6]=M(" 文件列表 "))]),o(f,{modelValue:E.value,"onUpdate:modelValue":a[0]||(a[0]=r=>E.value=r),placeholder:"搜索文件",size:"small",class:"sidebar-search",clearable:""},null,8,["modelValue"]),o(m,{class:"sidebar-list"},{default:i(()=>[(n(!0),d(S,null,Q(te.value,r=>(n(),d("div",{key:r.id,class:W(["sidebar-file",t.value&&r.id===t.value.id?"active":""]),onClick:D=>A(r)},[o(u,{class:"sidebar-file-icon"},{default:i(()=>a[7]||(a[7]=[l("i",{class:"el-icon-document"},null,-1)])),_:1,__:[7]}),l("span",Ke,I(r.filename),1)],10,Ae))),128))]),_:1}),l("div",je,[o(c,{"current-page":z.value,"onUpdate:currentPage":a[1]||(a[1]=r=>z.value=r),"page-size":P.value,"onUpdate:pageSize":a[2]||(a[2]=r=>P.value=r),total:B.value,"page-sizes":[1,10,20,50],layout:"sizes, prev, pager, next",size:"small",class:"sidebar-pagination"},null,8,["current-page","page-size","total"])])],512),[[Me,!b.value]]),l("div",Xe,[l("div",Ge,[o(u,{class:"sidebar-toggle-btn",onClick:a[3]||(a[3]=r=>b.value=!b.value),title:b.value?"展开文件列表":"收起文件列表"},{default:i(()=>[(n(),H(Ue(b.value?O(ze):O(Pe))))]),_:1},8,["title"]),l("span",qe,I((Z=t.value)==null?void 0:Z.filename),1),l("div",Ye,[o(T,{type:v.value==="origin"?"primary":"default",size:"small",onClick:a[4]||(a[4]=r=>G("origin"))},{default:i(()=>a[8]||(a[8]=[M("原文件")])),_:1,__:[8]},8,["type"]),o(T,{type:v.value==="markdown"?"primary":"default",size:"small",onClick:a[5]||(a[5]=r=>G("markdown"))},{default:i(()=>a[9]||(a[9]=[M("Markdown")])),_:1,__:[9]},8,["type"])]),o(he,{class:"download-btn",onCommand:de},{dropdown:i(()=>[o(ye,null,{default:i(()=>[(n(),d(S,null,Q(L,(r,D)=>o(ge,{key:D,command:D},{default:i(()=>[M(I(r),1)]),_:2},1032,["command"])),64))]),_:1})]),default:i(()=>[o(T,{type:"primary",size:"small"},{default:i(()=>[o(u,null,{default:i(()=>a[10]||(a[10]=[l("i",{class:"el-icon-download"},null,-1)])),_:1,__:[10]}),a[12]||(a[12]=M(" 下载 ")),o(u,null,{default:i(()=>a[11]||(a[11]=[l("i",{class:"el-icon-arrow-down"},null,-1)])),_:1,__:[11]})]),_:1,__:[12]})]),_:1})]),l("div",Ze,[v.value!=="markdown"?(n(),d("div",{key:0,class:W(["preview-left",{"full-width":v.value==="origin"}])},[l("div",Je,[se.value&&t.value?(n(),d(S,{key:0},[fe(t.value.filename)?(n(),d("div",Qe,[p.value?(n(),d("iframe",{key:0,src:p.value,style:{width:"100%",height:"calc(100vh - 20px)",border:"none"},ref_key:"pdfFrame",ref:C,onLoad:pe},null,40,ea)):$("",!0)])):j(t.value.filename)?(n(),d(S,{key:1},[N.value?(n(),d("div",aa,[o(u,{class:"is-loading"},{default:i(()=>[o(O(Ee))]),_:1}),a[13]||(a[13]=l("span",null,"正在加载预览...",-1))])):(n(),d("div",{key:1,class:"office-preview",innerHTML:h.value},null,8,ta))],64)):le(t.value.filename)?(n(),d("img",{key:2,src:p.value,style:{"max-width":"100%"}},null,8,sa)):K(t.value.filename)?(n(),H(m,{key:3},{default:i(()=>[l("pre",null,I(x.value),1)]),_:1})):(n(),H(ke,{key:4,description:"暂不支持该类型文件预览","image-size":80}))],64)):$("",!0)])],2)):$("",!0),v.value!=="origin"?(n(),d("div",{key:1,class:W(["preview-right",{"full-width":v.value==="markdown"}])},[l("div",la,[l("div",oa,[l("div",{class:"markdown-content",innerHTML:we.value},null,8,na),y.value?(n(),d("div",ra,"加载中...")):$("",!0)])])],2)):$("",!0)])])])}}}),_a=Be(ia,[["__scopeId","data-v-705c28fa"]]);export{_a as default};
