import{p as ce,a as pe,j as y,q as ue,o as me,v as _e,x as j,c as F,b as f,k as N,f as a,w as s,r as c,E as m,e as _,F as A,y as D,t as x,u as M,g as ge,z as fe,A as ve,i as C,_ as be}from"./index-6mw23_9c.js";import{a as v,g as h}from"./user-COjPqb4h.js";import{r as we}from"./jszip.min-B_GYlB3M.js";import{f as ye}from"./format-B3wa2IJS.js";var he=we();const ke=ce(he),Ce={class:"files-root"},ze={class:"files-card"},xe={class:"files-header"},Ue={class:"files-header-actions"},$e={class:"files-toolbar"},Ee={class:"pagination-container"},Re=3e3,Se=pe({__name:"Files",setup(Le){const u=y([]),U=y(0),$=y(!1),E=y(null),o=ue({page:1,pageSize:10,search:"",status:""}),R=y(""),S=y(!1),L=y([]),P=fe(),O={MARKDOWN:"markdown",MARKDOWN_PAGE:"markdown_page"},b={[O.MARKDOWN]:"Markdown",[O.MARKDOWN_PAGE]:"Markdown带页码"},X=t=>t?new Date(t).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}):"",K=t=>({pending:"info",parsing:"warning",parsed:"success",parse_failed:"danger"})[t]||"info",W=t=>({pending:"等待解析",parsing:"解析中",parsed:"已完成",parse_failed:"解析失败"})[t]||"未知状态",G=t=>{P.push({name:"FilePreview",params:{id:t.id}})},q=async(t,e)=>{if(!(!t||R.value===t.id)){R.value=t.id;try{const l=await v.get(`/api/files/${t.id}/export`,{params:{format:e},headers:{"X-User-Id":h()}});if(l.data.status==="success"){const p=await(await fetch(l.data.download_url)).blob(),r=window.URL.createObjectURL(p),d=document.createElement("a");d.href=r,d.download=l.data.filename,document.body.appendChild(d),d.click(),window.URL.revokeObjectURL(r),document.body.removeChild(d),m.success(`导出${b[e]}成功`)}else m.error(`导出${b[e]}失败`)}catch(l){console.error("导出失败:",l),m.error(`导出${b[e]}失败`)}finally{R.value=""}}},T=()=>{E.value&&(clearInterval(E.value),E.value=null)},J=t=>{if(u.value.length!==t.length){u.value=t;return}t.forEach((e,l)=>{const i=u.value[l];i.id===e.id&&i.status!==e.status&&(u.value[l]=e)})},Z=()=>{console.log("开始轮询..."),T(),E.value=window.setInterval(async()=>{await H()},Re)},H=async()=>{try{const t=await v.get("/api/files",{params:{page:o.page,page_size:o.pageSize,search:o.search,status:o.status},headers:{"X-User-Id":h()}});J(t.data.files),U.value=t.data.total}catch(t){console.error("轮询获取文件列表失败:",t)}},z=async()=>{$.value=!0;try{const t=await v.get("/api/files",{params:{page:o.page,page_size:o.pageSize,search:o.search,status:o.status},headers:{"X-User-Id":h()}});u.value=t.data.files,U.value=t.data.total}catch{m.error("获取文件列表失败"),u.value=[],U.value=0}finally{$.value=!1}},Q=t=>{ve.confirm("确定要删除该文件吗？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await v.delete(`/api/files/${t.id}`,{headers:{"X-User-Id":h()}}),m.success("删除成功"),z()}catch{m.error("删除失败")}}).catch(()=>{})},Y=async t=>{try{const e=await v.get(`/api/files/${t.id}/download_url`,{headers:{"X-User-Id":h()}}),l=await v.get(e.data.url,{responseType:"blob"}),i=new Blob([l.data]),p=window.URL.createObjectURL(i),r=document.createElement("a");r.href=p,r.download=t.filename,document.body.appendChild(r),r.click(),window.URL.revokeObjectURL(p),document.body.removeChild(r)}catch{m.error("下载失败")}},ee=async t=>{if(!(!L.value.length||S.value)){S.value=!0;try{const e=new ke;for(const r of L.value)try{const d=await v.get(`/api/files/${r.id}/export`,{params:{format:t},headers:{"X-User-Id":h()}});if(d.data.status==="success"){const w=await(await fetch(d.data.download_url)).blob();e.file(d.data.filename,w)}}catch(d){console.error(`导出文件 ${r.filename} 失败:`,d),m.error(`导出文件 ${r.filename} 失败`)}const l=await e.generateAsync({type:"blob"}),i=window.URL.createObjectURL(l),p=document.createElement("a");p.href=i,p.download=`batch_export_${new Date().getTime()}.zip`,document.body.appendChild(p),p.click(),window.URL.revokeObjectURL(i),document.body.removeChild(p),m.success(`批量导出${b[t]}完成`)}catch(e){console.error("批量导出失败:",e),m.error(`批量导出${b[t]}失败`)}finally{S.value=!1}}},te=t=>{L.value=t},ae=async t=>{try{await v.post(`/api/files/${t.id}/parse`,{},{headers:{"X-User-Id":h()}}),m.success("解析任务已提交");const e=u.value.findIndex(l=>l.id===t.id);e!==-1&&(u.value[e]={...u.value[e],status:"parsing"})}catch{m.error("解析任务提交失败")}},I=()=>{z()},ne=()=>{o.page=1,z()};return me(()=>{z().then(()=>{Z()})}),_e(()=>{T()}),j([()=>o.search,()=>o.status],()=>{ne()}),j([()=>o.page,()=>o.pageSize],()=>{z()}),(t,e)=>{const l=c("el-icon"),i=c("el-button"),p=c("el-dropdown-item"),r=c("el-dropdown-menu"),d=c("el-dropdown"),B=c("el-input"),w=c("el-option"),se=c("el-select"),k=c("el-table-column"),oe=c("el-tag"),le=c("el-table"),ie=c("el-empty"),re=c("el-skeleton"),de=c("el-pagination");return C(),F("div",Ce,[f("div",ze,[f("div",xe,[e[9]||(e[9]=f("span",{class:"files-title"},"文件列表",-1)),f("div",Ue,[a(d,{onCommand:ee,disabled:!L.value.length},{dropdown:s(()=>[a(r,null,{default:s(()=>[(C(),F(A,null,D(b,(n,g)=>a(p,{key:g,command:g},{default:s(()=>[_(x(n),1)]),_:2},1032,["command"])),64))]),_:1})]),default:s(()=>[a(i,{type:"info",size:"large",class:"batch-export-btn",loading:S.value,plain:""},{default:s(()=>[a(l,null,{default:s(()=>e[5]||(e[5]=[f("i",{class:"el-icon-download"},null,-1)])),_:1,__:[5]}),e[7]||(e[7]=_(" 批量导出 ")),a(l,null,{default:s(()=>e[6]||(e[6]=[f("i",{class:"el-icon-arrow-down"},null,-1)])),_:1,__:[6]})]),_:1,__:[7]},8,["loading"])]),_:1},8,["disabled"]),a(i,{type:"primary",size:"large",class:"upload-btn",onClick:e[0]||(e[0]=n=>t.$router.push("/upload"))},{default:s(()=>[a(l,null,{default:s(()=>[a(M(ge))]),_:1}),e[8]||(e[8]=_(" 上传文件 "))]),_:1,__:[8]})])]),f("div",$e,[a(B,{modelValue:o.search,"onUpdate:modelValue":e[1]||(e[1]=n=>o.search=n),placeholder:"请输入文件名称",class:"search-input",clearable:"","prefix-icon":"Search",onInput:I},null,8,["modelValue"]),a(se,{modelValue:o.status,"onUpdate:modelValue":e[2]||(e[2]=n=>o.status=n),placeholder:"筛选状态",class:"status-select",clearable:"",onChange:I},{default:s(()=>[a(w,{label:"全部",value:""}),a(w,{label:"等待解析",value:"pending"}),a(w,{label:"解析中",value:"parsing"}),a(w,{label:"已完成",value:"parsed"}),a(w,{label:"解析失败",value:"parse_failed"})]),_:1},8,["modelValue"])]),u.value&&u.value.length>0&&!$.value?(C(),N(le,{key:0,data:u.value,border:"",stripe:"",onSelectionChange:te},{default:s(()=>[a(k,{type:"selection",width:"48"}),a(k,{prop:"filename",label:"文件名称"}),a(k,{prop:"size",label:"大小",width:"120"},{default:s(({row:n})=>[_(x(M(ye)(n.size)),1)]),_:1}),a(k,{prop:"uploadTime",label:"创建时间",width:"180"},{default:s(({row:n})=>[_(x(X(n.upload_time)),1)]),_:1}),a(k,{prop:"status",label:"状态",width:"120"},{default:s(({row:n})=>[a(oe,{type:K(n.status)},{default:s(()=>[_(x(W(n.status)),1)]),_:2},1032,["type"])]),_:1}),a(k,{label:"操作",width:"260"},{default:s(({row:n})=>[a(i,{type:"primary",link:"",onClick:g=>G(n)},{default:s(()=>e[10]||(e[10]=[_("查看")])),_:2,__:[10]},1032,["onClick"]),a(i,{type:"success",link:"",onClick:g=>Y(n)},{default:s(()=>e[11]||(e[11]=[_("下载")])),_:2,__:[11]},1032,["onClick"]),a(i,{type:"danger",link:"",onClick:g=>Q(n)},{default:s(()=>e[12]||(e[12]=[_("删除")])),_:2,__:[12]},1032,["onClick"]),a(i,{type:"warning",link:"",onClick:g=>ae(n),disabled:n.status==="parsed"||n.status==="parsing",title:n.status==="parsed"?"文件已解析完成":n.status==="parsing"?"文件正在解析中":"开始解析"},{default:s(()=>e[13]||(e[13]=[_("解析")])),_:2,__:[13]},1032,["onClick","disabled","title"]),a(d,{onCommand:g=>q(n,g)},{dropdown:s(()=>[a(r,null,{default:s(()=>[(C(),F(A,null,D(b,(g,V)=>a(p,{key:V,command:V},{default:s(()=>[_(x(g),1)]),_:2},1032,["command"])),64))]),_:1})]),default:s(()=>[a(i,{type:"info",link:"",loading:R.value===n.id},{default:s(()=>[e[15]||(e[15]=_(" 导出 ")),a(l,null,{default:s(()=>e[14]||(e[14]=[f("i",{class:"el-icon-arrow-down"},null,-1)])),_:1,__:[14]})]),_:2,__:[15]},1032,["loading"])]),_:2},1032,["onCommand"])]),_:1})]),_:1},8,["data"])):$.value?(C(),N(re,{key:2,rows:6,animated:"",style:{margin:"32px 0"}})):(C(),N(ie,{key:1,description:"暂无数据","image-size":80,class:"files-empty"})),f("div",Ee,[a(de,{"current-page":o.page,"onUpdate:currentPage":e[3]||(e[3]=n=>o.page=n),"page-size":o.pageSize,"onUpdate:pageSize":e[4]||(e[4]=n=>o.pageSize=n),total:U.value,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next",onSizeChange:I,onCurrentChange:I},null,8,["current-page","page-size","total"])])])])}}}),Te=be(Se,[["__scopeId","data-v-6bd0037e"]]);export{Te as default};
